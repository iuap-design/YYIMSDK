YYIMChat=function(e){var t=e.constructor,r=function(){function t(t){var r={type:e.getConstants().TYPE.GET};t&&t.id&&(r.to=e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t.id))),e.getConnection().send(new JumpPacket(r,OPCODE.VCARD.SEND),function(t,r){r.complete&&r.complete();var o=t.vcard||{};o.id=o.userId=e.getJIDUtil().getID(o.username),t.enableFields&&(o.enableFields=!!t.enableFields),r.success&&r.success(o)},t)}function r(t){var r=e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/"+e.getUserID()+"/vcard?token="+e.getToken()+"&userids="+t.ids;jQuery.ajax({url:r,type:"get",dataType:"json",cache:!1,success:function(r){var o={};if(r&&r.list)for(var s in r.list)if(r.list.hasOwnProperty(s)){var n=r.list[s];n.id=e.getJIDUtil().getID(n.username),o[n.id]=n}t.success&&t.success(o),t=null},error:function(e){try{t.error&&t.error(JSON.parse(e.responseText)),t=null}catch(e){t.error&&t.error(),t=null}}})}function o(t){var r={type:"roster"};e.getConnection().send(new JumpPacket(r,OPCODE.VCARDS.SEND),function(t,r){var o=t.vcards||[];for(vcards=[],i=o.length;i--;){var s=o[i];s.id=s.userId=e.getJIDUtil().getID(s.username),vcards.push(s)}r.complete&&r.complete(),r.success&&r.success(vcards)},t)}function s(t){e.getConnection().send(new JumpPacket({type:e.getConstants().TYPE.SET,vcard:t.vcard},OPCODE.VCARD.SEND),function(e,t){t.complete&&t.complete(),t.success&&t.success()},t)}function n(t){var r;r=t.id&&t.id!==e.getUserID()?e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/"+e.getUserID()+"/"+t.id+"/roster/tag?token="+e.getToken():e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/"+e.getUserID()+"/vcard/tag?token="+e.getToken(),jQuery.ajax({url:r,type:"post",data:JSON.stringify({tag:t.tag}),dataType:"json",cache:!1,processData:!1,contentType:"application/json",success:function(e){t.success&&t.success(t.id),t=null},error:function(e){try{t.error&&t.error(JSON.parse(e.responseText)),t=null}catch(e){t.error&&t.error(),t=null}}})}function c(t){var r;r=t.id&&t.id!==e.getUserID()?e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/"+e.getUserID()+"/"+t.id+"/roster/tag?token="+e.getToken()+"&tag="+JSON.stringify(t.tag):e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/"+e.getUserID()+"/vcard/tag?token="+e.getToken()+"&tag="+JSON.stringify(t.tag),jQuery.ajax({url:r,type:"delete",dataType:"json",cache:!1,success:function(e){t.success&&t.success(t.id),t=null},error:function(e){try{t.error&&t.error(JSON.parse(e.responseText)),t=null}catch(e){t.error&&t.error(),t=null}}})}function a(t){jQuery.ajax({url:e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/"+e.getUserID()+"/presence/detail?token="+e.getToken()+"&username="+t.username,type:"get",dataType:"json",cache:!1,timeout:5e3,success:function(e){t.success&&t.success(e),t=null},error:function(e){try{t.error&&t.error(JSON.parse(e.responseText)),t=null}catch(e){t.error&&t.error(),t=null}}})}function g(t){var r=new JumpPacket({},OPCODE.ROSTER_LIST.SEND);e.getConnection().send(r,function(t,r){if(r){r.complete&&r.complete();for(var o=t.items||[],s=[],n=o.length||0,i={};n--;){var c=o[n],a=c.jid,g={id:e.getJIDUtil().getID(a),resource:e.getJIDUtil().getResource(a),ask:c.ask,recv:c.recv,name:c.name,photo:c.photo,subscription:c.subscription,group:c.groups,tag:c.tag};e.getJIDUtil().getDomain(a)!==e.getConfig().DOMAIN.PUBACCOUNT&&(s.push(g),i[g.id]||"none"!==g.subscription||1===g.recv&&(i[g.id]=g))}for(var u in i)i[u].id&&e.onSubscribe({from:i[u].id,type:e.getConstants().PRESENCE_TYPE.SUBSCRIBE});r.success&&r.success(JSON.stringify(s))}},t)}function u(t){var r={type:e.getConstants().TYPE.SET,ns:NS_ROSTER,item:{jid:t.jid,subscription:"remove"}};e.getConnection().send(new JumpPacket(r,OPCODE.UPDATE_ROSTER.SEND),function(t,r){r.complete&&r.complete(),r.success&&r.success(e.getJIDUtil().getID(r.jid))},t)}function E(t){for(var r=t.roster,o={item:{jid:r.jid,name:r.name,groups:[]}},s=r.groups,n=s?s.length:0;n--&&YYIMCommonUtil.isStringAndNotEmpty(s[n]);)o.item.groups=o.item.groups.concat(s[n]);e.getConnection().send(new JumpPacket(o,OPCODE.UPDATE_ROSTER.SEND),function(t,r){r.complete&&r.complete(),400===t.code?r.error&&r.error(t):(t.to=e.getJIDUtil().getID(t.to),r.success&&r.success(t))},t)}function d(t){var r={start:YYIMCommonUtil.isNumber(t.start)?t.start:0,size:YYIMCommonUtil.isNumber(t.size)?t.size:20,fields:["Username","Name"],search:t.keyword};e.getConnection().send(new JumpPacket(r,OPCODE.QUERY_USER.SEND),function(t,r){for(var o=t.items||[],s=[],n=o.length;n--;){var i=o[n],c=i.jid;c!==e.getUserBareJID()&&s.push({id:e.getJIDUtil().getID(c),name:YYIMCommonUtil.isStringAndNotEmpty(i.name)?i.name:e.getJIDUtil().getID(c),photo:i.photo,email:i.email})}r.complete&&r.complete(),r.success&&r.success({start:t.start,total:t.total,items:s})},t)}function l(t){jQuery.ajax({url:e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/"+e.getUserID()+"/favoritedRosters",type:"get",data:{token:e.getToken()},dataType:"json",cache:!1,success:function(r){if(r&&r.items)for(var o=r.items.length;o--;)r.items[o].id=e.getJIDUtil().getID(r.items[o].jid);t.success&&t.success(r.items),t=null},error:function(e){try{t.error&&t.error(JSON.parse(e.responseText)),t=null}catch(e){t.error&&t.error(),t=null}}})}function p(t){e.getConnection().send(new JumpPacket(t,OPCODE.PRESENCE.SEND))}function m(t){e.getConnection().send(new JumpPacket({type:e.getConstants().PRESENCE_TYPE.COLLECT,to:t},OPCODE.PRESENCE.SEND))}function f(t){e.getConnection().send(new JumpPacket({favoritedRosterItem:{jid:t,subscription:e.getConstants().FAVORITE_TYPE.REMOVE},from:e.getUserFullJID()},OPCODE.FAVORITED_ROSTERT.SEND))}function C(t,r){e.getConnection().send(new JumpPacket({favoritedRosterItem:{jid:t,name:r,subscription:e.getConstants().FAVORITE_TYPE.FAVORITE},from:e.getUserFullJID()},OPCODE.FAVORITED_ROSTERT.SEND))}function I(t){e.getConnection().send(new JumpPacket({type:e.getConstants().PRESENCE_TYPE.SUBSCRIBE,to:t},OPCODE.PRESENCE.SEND))}function T(t){e.getConnection().send(new JumpPacket({type:e.getConstants().PRESENCE_TYPE.SUBSCRIBED,to:t},OPCODE.PRESENCE.SEND))}function R(t){e.getConnection().send(new JumpPacket({type:e.getConstants().PRESENCE_TYPE.UNSUBSCRIBED,to:t},OPCODE.PRESENCE.SEND))}function S(){e.getConnection().registerHandler(OPCODE.FAVORITED_ROSTERT.KEY,function(t){t&&t.favoritedRosterItem&&(t.favoritedRosterItem.id=e.getJIDUtil().getID(t.favoritedRosterItem.jid)),t&&t.to&&(t.to=e.getJIDUtil().getID(t.to)),e.onRosterFavorited(t)}),e.getConnection().registerHandler(OPCODE.UPDATE_ROSTER.KEY,function(t){var r=t.item,o=e.getJIDUtil().getID(t.item.jid);"both"===r.subscription?(e.log("update or add: "+JSON.stringify(r)),r.id=o,e.onRosterUpdateded(r)):"none"===r.subscription?(e.log("delete: "+JSON.stringify(r)),r.id=o,e.onRosterDeleted(r)):r.subscription}),e.getConnection().registerHandler(OPCODE.PRESENCE.KEY,function(t){if(t.type&&t.type!=e.getConstants().TYPE.UNAVAILABLE)return void e.onSubscribe({from:e.getJIDUtil().getID(t.from),type:t.type});var r={from:e.getJIDUtil().getID(t.from),resource:e.getJIDUtil().getResource(t.from),type:t.type,show:t.show,status:t.status};t.type&&t.type==e.getConstants().TYPE.UNAVAILABLE&&(r.show=e.getConstants().STATUS.UNAVAILABLE,r.status=e.getConstants().STATUS.UNAVAILABLE,removeFromOnline(r.from)),YYIMCommonUtil.isStringAndNotEmpty(r.status)||(r.show=e.getConstants().STATUS.CHAT,r.status=e.getConstants().STATUS.CHAT),e.onPresence(r)})}return{monitor:S,approveSubscribe:T,rejectSubscribe:R,deleteRosterItem:u,queryRosterItem:d,getRostersPresence:a,updateRosterItem:E,setPresence:p,getVCard:t,getBatchVCards:r,getVCards:o,setVCard:s,addRosterItem:I,favoriteRoster:m,cancelFavoriteRoster:f,updateFavoriteRoster:C,getFavoriteRosterList:l,getRosterItems:g,setTag:n,removeTag:c}}();e.setBackhander({monitor:{rosterMonitor:r.monitor},initCallback:{roster:function(t){e.onPresence=t.onPresence||function(){},e.onSubscribe=t.onSubscribe||function(){},e.onRosterDeleted=t.onRosterDeleted||function(){},e.onRosterUpdateded=t.onRosterUpdateded||function(){},e.onRosterFavorited=t.onRosterFavorited||function(){}}}}),t.prototype.setPresence=function(e){var t={};e&&e.show&&this.getConstants().STATUS[e.show.toUpperCase()]&&(t.show=e.show),e&&e.status&&(t.status=e.status),r.setPresence(t)},t.prototype.getVCard=function(e){e=e||{},e?r.getVCard({id:e.id,success:e.success,error:e.error}):e.error&&e.error()};var o,s=new BaseList,n=function(){var t=s;s=new BaseList,r.getBatchVCards({ids:JSON.stringify(t.keys()),success:function(r){t.forEach(function(t,o){try{t&&t.success&&t.success(r[t.id])}catch(t){e.log("SuccessHandleBatchVCardsError.",0,t)}}),t.clear(),t=null},error:function(r){t.forEach(function(t,o){try{t&&t.error&&t.error(r)}catch(t){e.log("ErrorHandleBatchVCardsError.",0,t)}}),t.clear(),t=null}})};return t.prototype.getBatchVCards=function(e){e&&e.id&&!s.get(e.id)?(s.set(e.id,e),clearTimeout(o),s.length()>=this.getConfig().ROSTER.BATCHVCRADMAXLIMIT?n():o=setTimeout(function(){n()},200)):e.error&&e.error()},t.prototype.getVCards=function(e){e?r.getVCards({success:e.success,error:e.error,complete:e.complete}):e.error&&e.error()},t.prototype.setVCard=function(e){r.setVCard({vcard:{nickname:e.nickname,photo:e.photo,email:e.email,mobile:e.mobile,telephone:e.telephone,organization:e.organization,gender:e.gender,number:e.number,remarks:e.remarks,location:e.location,position:e.position},success:e.success,error:e.error})},t.prototype.setVCardTag=function(e){if(e=e||{},YYIMArrayUtil.isArray(e.tag)){var t=this;r.setTag({tag:e.tag,success:function(r){t.getVCard({id:r,success:function(t){e.success&&e.success(t)}})},error:e.error})}else e.error&&e.error()},t.prototype.removeVCardTag=function(e){if(e=e||{},YYIMArrayUtil.isArray(e.tag)){var t=this;r.removeTag({tag:e.tag,success:function(r){t.getVCard({id:r,success:function(t){e.success&&e.success(t)}})},error:e.error})}else e.error&&e.error()},t.prototype.setRosterTag=function(e){e=e||{},e.id&&YYIMArrayUtil.isArray(e.tag)&&e.id!=this.getUserID()?r.setTag({id:e.id,tag:e.tag,success:function(t){e.success&&e.success(t)},error:e.error}):e.error&&e.error()},t.prototype.removeRosterTag=function(e){e=e||{},e.id&&YYIMArrayUtil.isArray(e.tag)&&e.id!=this.getUserID()?r.removeTag({id:e.id,tag:e.tag,success:function(t){e.success&&e.success(t)},error:e.error}):e.error&&e.error()},t.prototype.getRosterItems=function(e){r.getRosterItems(e)},t.prototype.addRosterItem=function(t){YYIMCommonUtil.isStringAndNotEmpty(t)&&r.addRosterItem(e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t)))},t.prototype.approveSubscribe=function(t){YYIMCommonUtil.isStringAndNotEmpty(t)&&r.approveSubscribe(e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t)))},t.prototype.rejectSubscribe=function(t){YYIMCommonUtil.isStringAndNotEmpty(t)&&r.rejectSubscribe(e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t)))},t.prototype.deleteRosterItem=function(t){YYIMCommonUtil.isStringAndNotEmpty(t.id)&&r.deleteRosterItem({jid:e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t.id)),success:t.success,error:t.error})},t.prototype.queryRosterItem=function(e){YYIMCommonUtil.isStringAndNotEmpty(e.keyword)&&r.queryRosterItem(e)},t.prototype.getRostersPresence=function(e){YYIMArrayUtil.isArray(e.username)&&(e.username=JSON.stringify(e.username),r.getRostersPresence(e))},t.prototype.updateRosterItem=function(t){t&&t.roster&&YYIMCommonUtil.isStringAndNotEmpty(t.roster.id)&&r.updateRosterItem({roster:{jid:e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t.roster.id)),name:t.roster.name,groups:t.roster.groups},success:t.success,error:t.error})},t.prototype.favoriteRoster=function(t,o){if(YYIMUtil.isWhateType(t,"String")){var s=e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t));o==e.getConstants().FAVORITE_TYPE.REMOVE?r.cancelFavoriteRoster(s):r.favoriteRoster(s)}},t.prototype.updateFavoriteRoster=function(t,o){if(YYIMUtil.isWhateType(t,"String")&&YYIMUtil.isWhateType(o,"String")){var s=e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t));r.updateFavoriteRoster(s,o)}},t.prototype.getFavoriteRosterList=function(e){e=e||{},r.getFavoriteRosterList({success:e.success,error:e.error})},t.getInstance()}(YYIMChat);